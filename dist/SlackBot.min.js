var SlackBot={Controller:function(t){this.initialize(t)}};SlackBot.Controller.prototype={initialize:function(t){this.event=t},createOutputJson:function(t){var e=JSON.stringify(t);return ContentService.createTextOutput(e).setMimeType(ContentService.MimeType.JSON)},createOutputText:function(t){var e=t||"";return ContentService.createTextOutput(e).setMimeType(ContentService.MimeType.TEXT)},execute:function(){var t;return(t=this.event.parameter.command?new SlackBot.SlashCommands(this).execute():this.event.parameter.text?new SlackBot.OutgoingWebhook(this).execute():new SlackBot.EventsApi(this).execute())?"string"==typeof t?this.createOutputText(t):"[object Object]"===t.toString()?this.createOutputJson(t):this.createOutputText():this.createOutputText()},getBotAccessToken:function(){return this.botAccessToken},getVerificationToken:function(){return this.verificationToken},setBotAccessToken:function(t){return this.botAccessToken=t,this.webApi=new SlackBot.WebApi(t),this},setVerificationToken:function(t){return this.verificationToken=t,this}},SlackBot.registerBotCommand=function(t,e){SlackBot.EventsApi.prototype.commands[t]=e},SlackBot.registerEvent=function(t,e){SlackBot.EventsApi.prototype.handlers[t]||(SlackBot.EventsApi.prototype.handlers[t]=[]),SlackBot.EventsApi.prototype.handlers[t].push(e)},SlackBot.EventsApi=function(t){this.initialize(t)},SlackBot.EventsApi.prototype={defaultMessage:"そんなコマンドはないよ。",commands:{nop:function(){return null},help:function(){return"吾輩はBotである。ヘルプはまだない。"},ping:function(){return"PONG"}},handlers:{app_mention:[function(t,e){var n,r=t.eventsApi,i=e.event.text.split(/\s+/)[1];n=r.commands.hasOwnProperty(i)?r.commands[i](t,e):r.getDefaultMessage();var o=e.event.channel;return t.webApi.call("chat.postMessage","post",{channel:o,text:n}),n}]},initialize:function(t){((this.controller=t).eventsApi=this).params=JSON.parse(t.event.postData.contents)},callEventHandlers:function(){var t=this.params.event.type,e=this.handlers[t];if(!e)return null;for(var n=null,r=0;r<e.length;r++)n=e[r](this.controller,this.params);return n},execute:function(){var t=this.params.token;if(!this.verifyToken(t)){var e="invalid verification token: "+t;throw new Error(e)}var n=this.params.type;switch(n){case"event_callback":return this.callEventHandlers();case"url_verification":return this.params.challenge;default:throw e="not supported events api: "+n,new Error(e)}},getDefaultMessage:function(){return this.defaultMessage},verifyToken:function(t){return this.controller.getVerificationToken()===t}},SlackBot.Obj={isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)},isGASObject:function(t,e){return"[object JavaObject]"===Object.prototype.toString.call(t)&&(!e||t.toString()===e)},isInteger:function(t){return"number"==typeof t&&t%1==0},isNumber:function(t){return"number"==typeof t},isObject:function(t){return"[object Object]"===Object.prototype.toString.call(t)},isString:function(t){return"string"==typeof t},merge:function(){for(var t={},e=0;e<arguments.length;e++){var n=arguments[e];for(var r in n)n.hasOwnProperty(r)&&(t[r]=n[r])}return t}},SlackBot.registerOutgoingWebhook=function(t){SlackBot.OutgoingWebhook.prototype.handler=t},SlackBot.OutgoingWebhook=function(t){this.initialize(t)},SlackBot.OutgoingWebhook.prototype={handler:function(t,e){return e.text},initialize:function(t){this.controller=t,(this.outgoingWebhook=this).params=t.event.parameter},execute:function(){var t=this.params.token;if(!this.verifyToken(t)){var e="invalid verification token: "+t;throw new Error(e)}var n=this.handler(this.controller,this.params);return"string"==typeof n?{text:n}:n},verifyToken:function(t){return this.controller.getVerificationToken()===t}},SlackBot.registerSlashCommand=function(t,e){SlackBot.SlashCommands.prototype.handlers[t]=e},SlackBot.SlashCommands=function(t){this.initialize(t)},SlackBot.SlashCommands.prototype={handlers:{ping:function(){return"PONG"}},initialize:function(t){this.controller=t,(this.slashCommands=this).params=t.event.parameter},execute:function(){var t=this.params.token;if(!this.verifyToken(t)){var e="invalid verification token: "+t;throw new Error(e)}var n=this.params.command.substring(1),r=this.handlers[n];if(!r)return null;var i=r(this.controller,this.params);return"string"==typeof i?{response_type:"in_channel",text:i}:i},verifyToken:function(t){return this.controller.getVerificationToken()===t}},SlackBot.WebApi=function(t){this.initialize(t)},SlackBot.WebApi.prototype={initialize:function(t){this.token=t},call:function(t,e,n){if("get"!==e&&"json"!==e&&"post"!==e)throw new Error("invalid HTTP method");var r=this.createRequestParams(n),i=this.createApiUrl(t,e,r),o=this.createFetchOptions(e,r);return this.fetch(i,o)},createApiUrl:function(t,e,n){var r="https://slack.com/api/"+t;return"get"===e&&(r+=this.createQueryString(n)),r},createFetchOptions:function(t,e){var n={headers:{Authorization:"Bearer "+this.token},method:"json"===t?"post":t,muteHttpExceptions:!0};return"json"===t?(n.contentType="application/json; charset=utf-8",n.payload=JSON.stringify(e)):"post"===t&&(n.payload=e),n},createRequestParams:function(t){return SlackBot.Obj.merge({token:this.token},t||{})},createQueryString:function(r){return Object.keys(r).reduce(function(t,e,n){return t+(0===n?"?":"&")+encodeURIComponent(e)+"="+encodeURIComponent(r[e])},"")},fetch:function(t,e){this.error=null,this.result=null;try{this.response=UrlFetchApp.fetch(t,e)}catch(t){return this.error=t,!1}return 200===this.response.getResponseCode()&&(this.result=JSON.parse(this.response.getContentText()),this.result)}};