!function(t){void 0===t&&(t={});function e(t,e){this.initialize(t,e)}function o(t){this.initialize(t)}function n(t){this.initialize(t)}function s(t){this.initialize(t)}(t.Controller=e).prototype={initialize:function(t,e){if(t instanceof o)return this.di=t,this.config=this.di.getShared("config"),void(this.logger=this.di.getShared("logger"));var n=this.config=e||{},r=this.logger=new s(n.logLevel),i=this.di=this.createDI();i.setShared("config",n),i.setShared("controller",this),i.setShared("event",t),i.setShared("logger",new s(n.logLevel)),r.info(JSON.stringify(t))},check:function(){this.config.botAccessToken||this.logger.error("bot access token is not set"),this.config.verificationToken||this.logger.error("verification token is not set")},createDI:function(){return new o({eventsApi:function(t){return new n(t)},outgoingWebhook:function(t){return new i(t)},slashCommands:function(t){return new a(t)},webApi:function(t){return new h(t.getShared("config").botAccessToken)}})},createModule:function(){var t=this.di.getShared("event");return t.parameter.command?this.di.getShared("slashCommands"):t.parameter.text?this.di.getShared("outgoingWebhook"):this.di.getShared("eventsApi")},createOutputJson:function(t){var e=JSON.stringify(t);return this.logger.info("output application/json: "+e),ContentService.createTextOutput(e).setMimeType(ContentService.MimeType.JSON)},createOutputText:function(t){var e=t||"";return this.logger.info("output text/plain: "+e),ContentService.createTextOutput(e).setMimeType(ContentService.MimeType.TEXT)},execute:function(){this.check(),this.module=this.createModule();var t=this.fire(),e=this.finish(t);return this.sendLog(),e},finish:function(t){if(!t)return this.createOutputText();if(r.isString(t))try{return this.send(t)?this.createOutputText():this.createOutputText(t)}catch(t){return console.error(t.message),this.createOutputText(t.message)}return r.isObject(t)?this.createOutputJson(t):r.isGASObject(t)?t:(this.logger.error("invalid output content: "+t),this.createOutputText())},fire:function(){try{return this.module.execute()}catch(t){return t.message}},getChannelId:function(){if(!this.module)return this.config.channelId;var t=this.module.getChannelId();return t||this.config.channelId},send:function(t){if(!t)return!0;var e=this.getChannelId();if(!e)return!1;var n=this.di.get("webApi"),r={channel:e,text:t};if(!n.call("chat.postMessage","post",r))throw new Error(n.errorMessage);return!0},sendLog:function(){var t=this.logger.toString();try{return!!this.send(t)||(console.error(t),!1)}catch(t){return console.error(t.message),!1}},verifyToken:function(t){if(this.config.verificationToken===t)return null;var e="invalid verification token: "+t;throw this.logger.warn(e),new Error(e)}},o.prototype={initialize:function(t){return this.setAll(t),this},get:function(t){var e=this.services[t];if(!e)return null;if("[object Object]"===e.toString())return e;if("function"==typeof e)return this.services[t](this);throw new Error("not supported service value")},getShared:function(t){if(this.objects[t])return this.objects[t];var e=this.get(t);return e?(this.objects[t]=e,this.objects[t]):null},set:function(t,e){return this.objects[t]=null,this.services[t]=e,this},setAll:function(t){return this.objects={},this.services=t||{},this},setShared:function(t,e){return this.objects[t]=e,this}},t.registerBotCommand=function(t,e){n.prototype.commands[t]=e},t.registerEvent=function(t,e){n.prototype.handlers[t]||(n.prototype.handlers[t]=[]),n.prototype.handlers[t].push(e)},n.prototype={defaultMessage:"そんなコマンドはないよ。",commands:{nop:function(t){return t.getShared("logger").info("nop command was called"),null},help:function(t){return t.getShared("logger").info("help command was called"),"吾輩はBotである。ヘルプはまだない。"},ping:function(t){return t.getShared("logger").info("ping command was called"),"PONG"}},handlers:{app_mention:[function(t,e){var n,r=t.getShared("eventsApi"),i=t.getShared("logger"),o=e.event.text.split(/\s+/)[1];i.info("bot command: "+o),n=r.commands.hasOwnProperty(o)?(i.info("call command handler for "+o),r.commands[o](t,e)):(i.info("does not have any command handler for "+o),r.getDefaultMessage()),i.info("output of command handler: "+n);var s=e.event.channel;return t.get("webApi").call("chat.postMessage","post",{channel:s,text:n}),n}]},initialize:function(t){if(!(t&&t instanceof o))throw new Error("DI object must be passed");this.di=t,this.logger=t.getShared("logger"),this.params=JSON.parse(t.getShared("event").postData.contents)},callEventHandlers:function(){var t=this.params.event.type,e=this.handlers[t];if(!e)return this.logger.error("does not have any event handler for "+t),null;this.logger.info("call event handlers for "+t);for(var n=null,r=0;r<e.length;r++)n=e[r](this.di,this.params),this.logger.info("output of handler: "+n);return n},execute:function(){var t=this.di.getShared("controller");t.verifyToken(this.params.token);var e=this.params.type;switch(e){case"event_callback":return this.callEventHandlers();case"url_verification":return t.createOutputText(this.params.challenge);default:var n="not supported events api: "+e;throw this.logger.error(n),new Error(n)}},getChannelId:function(){return this.params.event.channel},getDefaultMessage:function(){return this.defaultMessage}},s.DEBUG=0,s.INFO=1,s.WARN=2,s.ERROR=3,s.FATAL=4,s.prototype={messages:[],initialize:function(t){this.level=void 0===t?s.WARN:t,this.messages=[]},debug:function(){return this.write(s.DEBUG,arguments)},info:function(){return this.write(s.INFO,arguments)},warn:function(){return this.write(s.WARN,arguments)},error:function(){return this.write(s.ERROR,arguments)},fatal:function(){return this.write(s.FATAL,arguments)},toString:function(){var n=[];return n[s.DEBUG]="DEBUG",n[s.INFO]="INFO",n[s.WARN]="WARN",n[s.ERROR]="ERROR",n[s.FATAL]="FATAL",this.messages.reduce(function(t,e){return t+e.time+": "+n[e.level]+": "+e.message+"\n"},"")},write:function(t,e){return t<this.level||this.messages.push({level:t,message:Utilities.formatString.apply(null,e),time:new Date}),this}};var r={isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)},isGASObject:function(t,e){return"[object JavaObject]"===Object.prototype.toString.call(t)&&(!e||t.toString()===e)},isInteger:function(t){return"number"==typeof t&&t%1==0},isNumber:function(t){return"number"==typeof t},isObject:function(t){return"[object Object]"===Object.prototype.toString.call(t)},isString:function(t){return"string"==typeof t},merge:function(){for(var t={},e=0;e<arguments.length;e++){var n=arguments[e];for(var r in n)n.hasOwnProperty(r)&&(t[r]=n[r])}return t}};function i(t){this.initialize(t)}function a(t){this.initialize(t)}function h(t){this.initialize(t)}t.registerOutgoingWebhook=function(t){i.prototype.handler=t},i.prototype={handler:function(t,e){return e.text},initialize:function(t){if(!(t&&t instanceof o))throw new Error("DI object must be passed");this.di=t,this.logger=t.getShared("logger"),this.params=t.getShared("event").parameter},execute:function(){this.di.getShared("controller").verifyToken(this.params.token),this.logger.info("call outgoing webhook handler");var t=this.handler(this.di,this.params);return this.logger.info("output of outgoing webhook handler: "+t),"string"==typeof t?{text:t}:t},getChannelId:function(){return this.params.channel_id}},t.registerSlashCommand=function(t,e){a.prototype.handlers[t]=e},a.prototype={handlers:{ping:function(t){return t.getShared("logger").info("ping slash command was called"),"PONG"}},initialize:function(t){if(!(t&&t instanceof o))throw new Error("DI object must be passed");this.di=t,this.logger=t.getShared("logger"),this.params=t.getShared("event").parameter},execute:function(){this.di.getShared("controller").verifyToken(this.params.token);var t=this.params.command.substring(1),e=this.handlers[t];if(!e)return this.logger.error("does not have any slash command handler for "+t),null;this.logger.info("call slash command handler for "+t);var n=e(this.di,this.params);return this.logger.info("output of slash command handler: "+n),"string"==typeof n?{response_type:"in_channel",text:n}:n},getArgs:function(){return this.params.text?this.params.text.trim().split(/\s+/):[]},getChannelId:function(){return this.params.channel_id}},h.prototype={initialize:function(t){this.token=t},call:function(t,e,n){if("get"!==e&&"json"!==e&&"post"!==e)throw new Error("invalid HTTP method");var r=this.createRequestParams(n),i=this.createApiUrl(t,e,r),o=this.createFetchOptions(e,r);return this.fetch(i,o)},createApiUrl:function(t,e,n){var r="https://slack.com/api/"+t;return"get"===e&&(r+=this.createQueryString(n)),r},createFetchOptions:function(t,e){var n={headers:{Authorization:"Bearer "+this.token},method:"json"===t?"post":t,muteHttpExceptions:!0};return"json"===t?(n.contentType="application/json; charset=utf-8",n.payload=JSON.stringify(e)):"post"===t&&(n.payload=e),n},createRequestParams:function(t){return r.merge({token:this.token},t||{})},createQueryString:function(r){return Object.keys(r).reduce(function(t,e,n){return t+(0===n?"?":"&")+encodeURIComponent(e)+"="+encodeURIComponent(r[e])},"")},fetch:function(t,e){this.error=null,this.errorMessage=null,this.response=null,this.result=null;try{this.response=UrlFetchApp.fetch(t,e)}catch(t){return this.error=t,this.errorMessage=t.errorMessage,!1}return 200!==this.response.getResponseCode()?(this.errorMessage=this.response.getContentText(),!1):(this.result=JSON.parse(this.response.getContentText()),this.result.ok?this.result:(this.errorMessage=this.result.error,!1))}}}("undefined"==typeof SlackBot?SlackBot={}:SlackBot);